<!DOCTYPE html>

<head>
<meta charset="UTF-8">
  
  <html lang="pt-br">
  <link href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyBpZD0iQ2FtYWRhXzIiIGRhdGEtbmFtZT0iQ2FtYWRhIDIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDU0Mi45MyA0MDUuNzYiPgogIDxkZWZzPgogICAgPHN0eWxlPgogICAgICAuY2xzLTEgewogICAgICAgIGZpbGw6ICNlNjUzMDA7CiAgICAgIH0KCiAgICAgIC5jbHMtMiB7CiAgICAgICAgZmlsbDogI2ZmNjcxZDsKICAgICAgfQogICAgPC9zdHlsZT4KICA8L2RlZnM+CiAgPGcgaWQ9IkNhbWFkYV8xLTIiIGRhdGEtbmFtZT0iQ2FtYWRhIDEiPgogICAgPGc+CiAgICAgIDxjaXJjbGUgY2xhc3M9ImNscy0yIiBjeD0iMzEyLjA0IiBjeT0iODMuMzIiIHI9IjcxLjY4Ii8+CiAgICAgIDxyZWN0IGNsYXNzPSJjbHMtMSIgeD0iODkuMzciIHk9IjEyOS40NSIgd2lkdGg9Ijc4LjkyIiBoZWlnaHQ9IjI4NS40NyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjMwLjIgLTExLjM4KSByb3RhdGUoNDUpIi8+CiAgICAgIDxyZWN0IGNsYXNzPSJjbHMtMSIgeD0iLTEwLjciIHk9Ijg3LjY0IiB3aWR0aD0iMjgxLjI5IiBoZWlnaHQ9IjgwLjY4IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjguNTUgLTU0LjQpIHJvdGF0ZSg0NSkiLz4KICAgICAgPHJlY3QgY2xhc3M9ImNscy0yIiB4PSIyMDcuMTIiIHk9IjI2NS44IiB3aWR0aD0iMjAxLjcxIiBoZWlnaHQ9IjgwLjQyIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzMDYuNTggLTEyOC4xNCkgcm90YXRlKDQ1KSIvPgogICAgICA8cmVjdCBjbGFzcz0iY2xzLTIiIHg9IjM3OS4xNCIgeT0iMTQ1Ljg0IiB3aWR0aD0iNzkuMzgiIGhlaWdodD0iMjcxLjYyIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzMjEuODMgLTIxMy42Nykgcm90YXRlKDQ1KSIvPgogICAgPC9nPgogIDwvZz4KPC9zdmc+" rel="icon" type="image/svg+xml"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DEV.associados</title>
  <meta name="theme-color" content="#f57c00">
  <style>
    :root {
      --color-primary: #f57c00;
      --color-background: #121212;
      --color-text: white;
    }
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--color-background);
      color: var(--color-text);
    }
    .pagina {
      display: none;
      padding: 40px 20px;
    }
    .pagina.ativa {
      display: block;
    }
    .menu {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .box {
  width: 250px;
  height: 150px;
  background: var(--color-background);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s ease, transform 0.2s ease;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}
.box:hover {
  background: var(--color-primary);
  transform: scale(1.03);
}

    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .voltar {
    position: fixed;
    top: 10px;
    left: 20px;
    z-index: 9999;
    display: block;
	  background: var(--color-primary);
  color: color-contrast(var(--color-primary) vs white, black);
	background: orange;
	font-weight: bold;
    }
	.logout {
    position: fixed;
    top: 55px;
    right: 20px;
    z-index: 9999;
    display: block;
	  background: var(--color-primary);
  color: color-contrast(var(--color-primary) vs white, black);;
	background: red;
	font-weight: bold;
    }
    #erroSerial {
      color: red;
      display: none;
    }
    input, button {
      padding: 10px;
      margin: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }
    input {
      width: 300px;
      background: #2a2a2a;
      color: white;
    }
    button.validar {
      background: #f57c00;
      color: white;
      cursor: pointer;
    }
	    body { 
height: 100vh;
overflow-y: auto;

}


    input, button { padding: 10px; margin: 10px; border: none; border-radius: 5px; font-size: 16px; }
    input { width: 300px; background: #2a2a2a; color: white; }
    button { background: #f57c00; color: white; cursor: pointer; }
    #erroSerial { color: red; display: none; }
  .status-shape {
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  color: white;
  height: 100px;
  min-width: 100px;
  padding: 10px;
  text-align: center;
}

.shape-green {
  background: #4caf50;
  border-radius: 16px;
  width: 200px;
}

.shape-yellow {
  background: #ffc107;
  clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
  width: 100px;
}

.shape-red {
  background: #f44336;
  border-radius: 50%;
  width: 100px;
}		

.pin-select-group {
position: absolute;
  top: 1px;
  right: -131px;
  display: flex;
  gap: 6px;
  align-items: center;
  z-index: 2;
}


.pin-select-group .pin-toggle {
  transform: scale(0.7);
  margin-right: -150px;
  cursor: pointer;
  z-index: 3;
}

.pin-select-group .select-toggle {
  transform: scale(1.7);
  cursor: pointer;
}
	
.media-upload {
  border: 2px dashed var(--color-primary);
  padding: 10px;
  border-radius: 12px;
  text-align: center;
  margin-bottom: 10px;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.3);
  transition: background 0.2s ease;
}
.media-upload:hover {
  background: rgba(245, 124, 0, 0.1);
}
.media-preview {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 10px;
}
.media-preview > * {
  max-width: 100%;
  border-radius: 8px;
}
.media-preview video, .media-preview audio {
  max-width: 100%;
}
.drag-ghost {
  opacity: 0.4;
  background: #f0f0f0;
}
.card {
  background: white;
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;

}
.card:hover {
  transform: translateY(-4px);
}
:root {
  --color-primary: #f57c00;
  --color-background: #ffffff;
  --color-text: #000000;
}
* { box-sizing: border-box;  padding: 0; }
html, body { font-family: 'Inter', sans-serif; font-size: 14px; }
header { background: var(--color-primary); padding: 20px; color: white; text-align: center; }
.container { max-width: 1000px; margin: auto; padding: 20px; }
.controls, .actions { display: flex; gap: 2px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
.controls input[type="text"], .controls button, .controls label, .actions button {
  background: var(--color-primary);
  color: white;
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  height: 38px;
  font-size: 13px;
  cursor: pointer;
}
.controls select {
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0 8px;
  height: 38px;
  font-size: 13px;
  cursor: pointer;
}
.controls label { display: flex; align-items: center; gap: 5px; }
.controls input[type="color"] {
  width: 30px; height: 30px; padding: 0; background: var(--color-primary); border: none; border-radius: 8px; cursor: pointer;
}
.grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; margin-top: 40px;}
.card { padding: 15px; border: 1px solid; border-radius: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; }
textarea { width: 100%; padding: 8px; border-radius: 10px; margin-bottom: 10px; resize: vertical; border: 1px solid #ccc; font-size: 14px; }
.emoji-dropdown { position: relative; display: inline-block; }
.emoji-menu {
  position: absolute;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  z-index: 9999 !important;

  display: none;
  position: absolute;
  background: var(--color-background);
  color: var(--color-text);
  border: 1px solid #ccc;
  border-radius: 8px;
  width: 240px;
  padding: 10px;
  top: 50px;
  left: 0;
  z-index: 10;
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 0.3s ease, transform 0.3s ease;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  max-height: 300px;
  overflow-y: auto;
}
.emoji-menu.show { display: block; opacity: 1; transform: translateY(0); }
.emoji-category { margin-bottom: 10px; }
.emoji-category-title { font-weight: bold; margin-bottom: 5px; font-size: 14px; color: var(--color-primary); }
.emoji-item { font-size: 18px; cursor: pointer; padding: 4px; display: inline-block; }
.emoji-item:hover { background: #eee; border-radius: 4px; }
body.light-mode { background: #fff; color: #000; }
body.light-mode .card { background: #fff; border-color: #ddd; }
body.dark-mode {
  background: #121212;
  color: #eee;
  --color-background: #1e1e1e;
  --color-text: #eeeeee;
}
body.dark-mode .card { background: #1e1e1e; border-color: #333; }
.emoji-button {
  background: var(--color-primary);
  color: white;
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  height: 38px;
  font-size: 13px;
  cursor: pointer;
  margin-top: 8px;
  margin-right: 8px;
}

.text-editable-area {
  width: 100%;
  padding: 8px;
  font-size: 14px;
  border-radius: 10px;
  resize: vertical;
  border: 1px solid #ccc;
  pointer-events: auto;
  user-select: text;
  position: relative;
  z-index: 1;
  background: var(--color-background);
  color: var(--color-text);
}
.card-header {
  cursor: grab;
  user-select: none;
  padding: 5px 0;
  font-weight: 600;
  margin-top: -20px;
  margin-bottom: -10px;
  margin-left: -10px;
  margin-right: 70px;
  
.controls {
  display: flex;
  flex-wrap: nowrap;
  gap: 8px;
  padding: 12px;
  overflow-x: auto;
  overflow-y: hidden;
  width: 100%;
  background: var(--color-background);
  position: sticky;
  top: 0;
  z-index: 100;
  scrollbar-width: thin;
  scrollbar-color: var(--color-primary) transparent;
}

/* Personalização da barra de rolagem (opcional) */
.controls::-webkit-scrollbar {
  height: 6px;
}

.controls::-webkit-scrollbar-track {
  background: transparent;
}

.controls::-webkit-scrollbar-thumb {
  background-color: var(--color-primary);
  border-radius: 3px;
}

/* Mantenha seus estilos existentes para os botões */
.controls button, 
.controls input, 
.controls select, 
.controls label {
  flex-shrink: 0; /* Impede que os itens encolham */
  height: 38px;
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: var(--color-primary);
  color: white;
  font-size: 13px;
  cursor: pointer;
}

/* Estilo específico para inputs de texto */
.controls input[type="text"] {
  min-width: 120px;
}

/* Estilo para o seletor de cor */
.controls input[type="color"] {
  width: 38px;
  padding: 4px;
} 
body {
  font-family: sans-serif;
  background: var(--color-background);
  color: var(--color-text);
  margin: 0;
  padding: 0;
  overflow-y: auto; /* Garante rolagem vertical */
}
body {
  font-family: sans-serif;
  background: var(--color-background);
  color: var(--color-text);
  margin: 0;
  padding: 0;
  overflow-y: auto; /* (opcional, mas ajuda) */
}
button.voltar {
  position: fixed;
  top: 55px;
  right: 20px;
  padding: 8px 15px;
  background: #f44336;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  z-index: 1000;
  transition: background 0.3s; /* Adicionei transição suave */
}

/* Efeito hover opcional */
button.voltar:hover {
  background: #d32f2f;
}
button.logout {
    position: fixed;
    top: 55px;
    right: 20px;
    padding: 8px 15px;
    background: #f44336;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    z-index: 1000;
	
}
  </style>
</head>
<body>
<!-- Página de Autenticação -->
<div id="page-auth" class="pagina ativa">
  <h2 style="text-align: center;">🔐 Acesso Restrito</h2>
 <input id="serialInput" placeholder="Insira seu serial key" type="text" style="
    display: block; 
    margin: 0 auto; 
    width: 90%; 
    max-width: 300px; 
    padding: 8px;
    text-align: center;  /* Centraliza o texto do placeholder */
    border: 1px solid #ccc; /* Opcional: melhora a visualização */
    border-radius: 4px; /* Opcional: bordas arredondadas */
	
    background: var(--color-primary);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  ">
  <button 
  onclick="validarSerial()" 
  style="display: block; margin: 10px auto;"
>
  Entrar
</button>
  <div id="erroSerial" style="display: block; text-align: center; margin: 10px auto; padding: 8px;">
  Serial inválido ou expirado
</div>	
  
 <!-- BOTÃO DE PAGAMENTO CUSTOMIZADO -->
<div style="text-align: center; margin: 0px auto;">
  <button onclick="abrirPopupPagamento()" style="background: #f57c00; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
    🔓 Libere o acesso!
  </button>
</div>

<!-- POPUP PAGAMENTO -->
<div id="popupPagamento" onclick="fecharPopupPagamento()" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center;">
  <div onclick="event.stopPropagation()" style="background: #222; color: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 400px;">
    <h2 style="margin-top: 0;">💳 Pagamento via Pix</h2>

    <label>Duração:
      <select id="selectMesesPagamento" onchange="atualizarValorPagamento()" style="width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: none;">
        <option value="1">1 mês</option>
        <option value="2">2 meses</option>
        <option value="3">3 meses</option>
        <option value="4">4 meses</option>
        <option value="5">5 meses</option>
        <option value="6">6 meses</option>
      </select>
    </label>

    <div id="valorPagamento" style="font-size: 18px; margin-bottom: 20px;">Valor total: R$ 35,00</div>

    <div style="margin-bottom: 10px;">
      <strong>Chave Pix:</strong><br>
      <code style="color: #0f0;">60.788.906/0001-44</code>
    </div>

    <button onclick="gerarQRCodePagamento()" style="background: #4caf50; color: white; border: none; padding: 10px 16px; border-radius: 8px; width: 100%;">Gerar QR Code</button>

    <div id="qrPagamento" style="text-align: center; margin: 20px 0;"></div>

    <button onclick="fecharPopupPagamento()" style="background: #f57c00; color: white; border: none; padding: 10px 16px; border-radius: 8px; width: 100%;">Fechar</button>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
const precoBasePagamento = 35;
const descontoPagamento = [0, 0, 3, 5, 8, 13, 21];

function abrirPopupPagamento() {
  document.getElementById('popupPagamento').style.display = 'flex';
  atualizarValorPagamento();
}

function fecharPopupPagamento() {
  document.getElementById('popupPagamento').style.display = 'none';
}

function atualizarValorPagamento() {
  const meses = parseInt(document.getElementById('selectMesesPagamento').value);
  let valor = meses * precoBasePagamento;
  if (meses <= 6) valor -= descontoPagamento[meses];
  document.getElementById('valorPagamento').innerText = `Valor total: R$ ${valor.toFixed(2).replace('.', ',')}`;
}

function gerarQRCodePagamento() {
  const meses = parseInt(document.getElementById('selectMesesPagamento').value);
  let valor = meses * precoBasePagamento;
  if (meses <= 6) valor -= descontoPagamento[meses];
  const payload = gerarPayloadPixPagamento(valor);
  const qrContainer = document.getElementById('qrPagamento');
  qrContainer.innerHTML = '';

  const qr = new QRious({ value: payload, size: 220 });
  qrContainer.appendChild(qr.element);

  const linkWhats = document.createElement('a');
  linkWhats.href = `https://wa.me/5577998199103?text=Pagamento de R$ ${valor.toFixed(2).replace('.', ',')}`;
  linkWhats.target = '_blank';
  linkWhats.innerText = 'Enviar via WhatsApp';
  Object.assign(linkWhats.style, {
    display: 'block', marginTop: '10px', background: '#25d366',
    color: 'white', padding: '10px', borderRadius: '8px', textAlign: 'center'
  });
  qrContainer.appendChild(linkWhats);
}

function gerarPayloadPixPagamento(valor) {
  const cnpj = '60788906000144';
  const nome = 'Lucas Oliveira Gomes';
  const cidade = 'LEM BA';
  const v = valor.toFixed(2);

  const payload = [
    '000201',
    '26360014BR.GOV.BCB.PIX',
    `01${cnpj.length.toString().padStart(2, '0')}${cnpj}`,
    '52040000',
    '5303986',
    `54${v.length.toString().padStart(2, '0')}${v}`,
    '5802BR',
    `59${nome.length.toString().padStart(2, '0')}${nome}`,
    `60${cidade.length.toString().padStart(2, '0')}${cidade}`,
    '62070503***',
    '6304'
  ].join('');

  return payload + crc16Pagamento(payload);
}

function crc16Pagamento(payload) {
  let polinomio = 0x1021, resultado = 0xFFFF;
  for (let i = 0; i < payload.length; i++) {
    resultado ^= payload.charCodeAt(i) << 8;
    for (let j = 0; j < 8; j++) {
      resultado = ((resultado << 1) & 0xFFFF) ^ ((resultado & 0x8000) ? polinomio : 0);
    }
  }
  return resultado.toString(16).toUpperCase().padStart(4, '0');
}
</script>

  </div>

</div>

  <!-- Página Menu -->
  <div id="page-menu" class="pagina">
    <h1 style="text-align: center;">📁 Menu Principal</h1>
    <div class="menu">
      <div class="box" onclick="navegarPara('page-automacao')">Automação para Grupos</div>
      <div class="box" onclick="navegarPara('page-automacao2')">Em breve...</div>
    </div><button class="logout" onclick="logout()">Sair</button></div>

  <!-- Página Automação -->
  <div id="page-automacao" class="pagina">
   <button class="voltar" onclick="navegarPara('page-menu')">← Voltar</button>
	
 <header style="padding-top: 70px;position: fixed; top: 0; left: 0; width: 100%; color: var(--color-background); background: var(--color-primary);z-index: 1000; padding: 10px 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
  <a href="https://idolink.com.br/devassociados" style="text-decoration: none; " target="_blank">
    <h1 style="font-size: 41px; line-height: 1; font-style: normal; margin: 10px 0;color: var(--color-background);letter-spacing: 0.009em;">DEV.associados</h1>
    <h4 style="line-height: 0; letter-spacing: 0.161em; font-size: 13.5px; margin: 10px 0;color: var(--color-background);background: var(--color-primary);">sua agência de marketing integrado</h4>
  </a>
</header>
<div class="controls-fixed">
  <div class="controls">

<!-- Botão de IA -->
<button onclick="abrirPopupIA()">🤖 Gerar Copy</button>
<style>
.controls-container {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--color-background);
  padding: 10px 0;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  width: 100%;
}

.controls-scroll {
  overflow-x: auto;
  padding-bottom: 6px;
  width: 100%;
  display: flex;
  justify-content: center; /* Centraliza horizontalmente */
}

.controls {
  display: inline-flex;
  gap: 8px; /* Aumentei o gap para melhor espaçamento */
  padding: 0 12px;
  padding-top: 80px;
  flex-wrap: wrap; /* Permite quebra de linha */
  justify-content: center; /* Centraliza os itens */

  margin: 0 auto; /* Centraliza o container */
}

.controls button, 
.controls input, 
.controls select {
  flex-shrink: 0;
  height: 38px;
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: var(--color-primary);
  color: white;
  font-size: 13px;
  cursor: pointer;
  margin: 2px; /* Pequeno espaçamento entre itens */
}

/* Estilo para inputs de texto */
.controls input[type="text"] {
  min-width: 120px;
}

/* Estilo para o seletor de cor */
.controls input[type="color"] {
  width: 38px;
  padding: 4px;
}

/* Melhorias para responsividade */
@media (max-width: 768px) {
  .controls {
    gap: 6px;
    padding: 10px;
    padding-top: 60px;
  }
  
  .controls button, 
  .controls input, 
  .controls select {
    padding: 6px 10px;
    font-size: 12px;
  }
}
</style>
<!-- Popup IA -->
<div id="popupIA" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:10000;">
  <div onclick="event.stopPropagation()" style="background:var(--color-background); color:var(--color-text); padding:20px; border-radius:10px; width:90%; max-width:800px;">
    <h1>🧾Gerar com IA<br>
     <h3>API Key 
	 <input type="text" id="apiKeyInput" placeholder="Insira sua API Key">
	
  <button onclick="salvarApiKey()">💾 Salvar API Key</button><h3>

<div class="chat-box" id="chatBox"></div>
    <textarea id="userPromptIA" placeholder="Digite o que deseja pedir para a IA..." style="background:var(--color-background); color:var(--color-text)width:100%; height:100px;"></textarea>
<label>Provedor:
  <select id="providerSelector" onchange="carregarApiKey()">
    <option value="Gemini">Google Gemini</option>
    <option value="OpenAI">OpenAI (ChatGPT)</option>
    
  </select>
</label>
<script>
document.addEventListener('click', function (e) {
  const popup = document.getElementById('popupIA');
  if (popup.style.display === 'flex' && e.target === popup) {
    fecharPopupIA();
  }
});
</script>



    
    <textarea id="respostaIA" style="margin-top: 10px;background:var(--color-background); color:var(--color-text)margin-top:10px; width: 100%; height: 200px; border: 1px solid #ccc; padding: 10px; box-sizing: border-box;" readonly>
  Aqui viria a minha resposta...
</textarea>
<div style="display:flex; justify-content: flex-end; gap:10px; margin-top:10px;">
      <button onclick="fecharPopupIA()">Fechar</button>
      <button onclick="enviarPromptIA()">Enviar</button>
<button onclick="abrirSeletorDeInsercaoIA()">Inserir em Saudação</button>
    </div>
  </div>
</div>


<button onclick="baixarPaginaHTML()" hidden>⬇️ Baixar HTML</button>
<input id="searchBox" oninput="filterSections()" placeholder="Buscar..." type="text"/>
<input id="newSection" placeholder="Nova saudação..." type="text"/>
<button onclick="addSection()">Adicionar</button>
<button onclick="openEmojiManager()">Gerenciar 😊</button>
<label>Cor<input onchange="changePrimaryColor(this.value)" type="color"/></label>
<label>
<select id="themeSelector" onchange="changeTheme (this.value)">
<option value="auto">🌗</option>
<option value="light">☀️</option>
<option value="dark">🌑</option>
</select>
</label>
<button onclick="saveToLocalStorage(); showToast('Configurações salvas!')">💾 Salvar</button>
<button onclick="exportarConfiguracoes()">⬇️ Exportar</button>
<button onclick="importarConfiguracoes()">⬆️ Importar</button>
<button onclick="undo()">↩️ Desfazer</button>
<button onclick="redo()">↪️ Refazer</button>
<button onclick="resetConfig()">Redefinir</button>
<input id="fileInput" onchange="handleFile(event)" style="display:none" type="file"/>
<select id="groupSelector" onchange="changeGroup(this.value)"></select>
<button onclick="createGroup()">Adicionar Grupo</button>
<button onclick="renameGroup()">Renomear Grupo</button>
<button onclick="deleteGroup()">Excluir Grupo</button>
<button onclick="excluirSelecionadas()">🗑️ Excluir Seleção</button>
<button onclick="moveSelectedSections()">Mover Seleção</button></div>
<div class="grid" id="sections"></div>
</div>
<div id="emojiManagerModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
<div style="background:var(--color-background); color:var(--color-text); padding:20px; border-radius:16px; max-width:500px; width:90%; max-height:90%; overflow-y:auto; position:relative;">
<h2>Gerenciar Emojis</h2>
<div id="emojiCategories"></div>
<button class="emoji-button" onclick="addEmojiCategory()">+ Nova Categoria</button>
<br/><br/>
<button class="emoji-button" onclick="closeEmojiManager()">Fechar</button>
</div>
</div>
<script>
let emojiData = {
  "Carinhas": ["😀", "😃", "😁", "😂"]
};
let groups = {
  "Padrão": {
    "Bom dia": ["Olá, bom dia! ☀️"],
    "Boa tarde": ["Olá, boa tarde! ⛅️"],
    "Boa noite": ["Olá, boa noite! 🌙"]
  }
};
let currentGroup = "Padrão";
let currentTextId = null;
let mediaStorage = JSON.parse(localStorage.getItem('mediaStorage') || '{}');

function saveToLocalStorage() {
  const allData = {
    groups,
    currentGroup,
    emojiData,
    mediaStorage,
    pinnedSections,
    themeMode: localStorage.getItem('themeMode') || 'auto',
    primaryColor: localStorage.getItem('primaryColor') || '#f57c00'
  };
  localStorage.setItem('saudacoesData', JSON.stringify(allData));
  localStorage.setItem("api_keys_ia", JSON.stringify(apiKeys));
  localStorage.setItem("currentGroup", currentGroup);
}


function populateGroupSelector() {
  const selector = document.getElementById('groupSelector');
  selector.innerHTML = '';
  Object.keys(groups).forEach(group => {
    const opt = document.createElement('option');
    opt.value = group;
    opt.textContent = group;
    if (group === currentGroup) opt.selected = true;
    selector.appendChild(opt);
  });
}

function changeGroup(group) {
  currentGroup = group;

  selectedSections.clear();     // ✅ limpa caixas selecionadas (checkbox "Selecionar")
  currentTextId = null;         // ✅ limpa o foco de edição ativa
  render();                     // 🔁 atualiza interface

  saveToLocalStorage();
  populateGroupSelector();
}



function createGroup() {
  const name = prompt("Nome do novo grupo:");
  if (name && !groups[name]) {
    groups[name] = {};
    currentGroup = name;
    saveToLocalStorage();
    populateGroupSelector();
    render();
  }
}

function renameGroup() {
  const newName = prompt("Novo nome para o grupo:", currentGroup);
  if (newName && newName !== currentGroup) {
    if (groups[newName]) {
      showToast("Já existe um grupo com esse nome!");
      return;
    }
    groups[newName] = groups[currentGroup];
    delete groups[currentGroup];
    currentGroup = newName;
    saveToLocalStorage();
    populateGroupSelector();
    render();
  }
}

function deleteGroup() {
  const options = [
    "Cancelar",
    "Excluir apenas o grupo (manter saudações)",
    "Excluir grupo e todas as saudações"
  ];
  const choice = prompt(`Deseja excluir o grupo "${currentGroup}"?\n0 - ${options[0]}\n1 - ${options[1]}\n2 - ${options[2]}`);

  if (choice === "1") {
    const copy = groups[currentGroup];
    delete groups[currentGroup];
    Object.assign(groups["Padrão"] ||= {}, copy);
  } else if (choice === "2") {
    delete groups[currentGroup];
  } else {
    return;
  }

  currentGroup = Object.keys(groups)[0] || "Padrão";
  saveToLocalStorage();
  populateGroupSelector();
  render();
}


function loadFromLocalStorage() {
  const saved = localStorage.getItem('saudacoesData');
  if (saved) {
    const parsed = JSON.parse(saved);
    groups = parsed.groups || { "Padrão": {} };
    currentGroup = parsed.currentGroup || localStorage.getItem("currentGroup") || "Padrão";
    emojiData = parsed.emojiData || { "Carinhas": ["😀", "😃", "😁", "😂"] };
    mediaStorage = parsed.mediaStorage || {};
    pinnedSections = parsed.pinnedSections || {};
  } else {
    groups = { "Padrão": {} };
    currentGroup = "Padrão";
  }
}

function createCard(title, messages, isPinned) {
  const card = document.createElement('div');
  card.className = 'card' + (isPinned ? ' pinned' : '');
  card.innerHTML = `
	
<div class="card-header">
  <h2 style="margin: 20px 0;margin-right: 10px;margin-left: 10px;"><span class="drag-handle" style="cursor: grab; user-select: none;">⠿</span> ${title}</h2>
</div>

    
         <input type="file" accept="image/*,video/*,audio/*,application/pdf" multiple style="display:none" id="input-${title}" onchange="handleMediaUpload(event, '${title}')">
    </div>
    <div class="media-preview" id="preview-${title}">${generateMediaPreview(title)}</div>
    
   	
    <div class="actions">

   
    
    <div class="pin-select-group">
  <button class="pin-toggle" onclick="togglePin('${title}')">${pinnedSections[title] ? "📌" : "📍"}</button>
  <input type="checkbox" class="select-toggle" onchange="toggleSectionSelection('${title}')" ${selectedSections.has(title) ? 'checked' : ''}/>
</div>

    ${
     messages.map((msg, i) => `<textarea class="text-editable-area" id="${title}-${i}" onfocus="setActiveTextId('${title}-${i}')" oninput="updateMessage('${title}', ${i}, this.value)">${msg}</textarea>`).join('')
    }

    <div class="actions">
	<button onclick="enviarSaudacaoWhatsApp('${title}')">📲 Enviar via WhatsApp em breve!</button>

      <button onclick="addMessage('${title}')">+ Caixa</button>
      <button onclick="removeMessage('${title}')">- Caixa</button>
      <button onclick="wrapText(currentTextId, '*')">Negrito</button>
      <button onclick="wrapText(currentTextId, '_')">Itálico</button>
      <button onclick="copySelectedText()">Copiar</button>
      <button onclick="renameSection('${title}')">Renomear</button>
	  <button onclick="addMediaFromPath('${title}')">📂 Caminho Local</button>
	  
      <div class="emoji-dropdown">
        <button onclick="toggleEmojiMenu(this)">😊 Emojis</button>
        <div class="emoji-menu">
          <input type="text" placeholder="Buscar emoji..." oninput="filterEmojis(this)" style="width: 100%; padding: 5px; margin-bottom: 10px;">
          ${generateEmojiMenu()}
        </div>
      </div>
	  <button onclick="addMediaUrl('${title}')">📎 Importar via URL</button>
      <button onclick="removeSection('${title}')">Excluir</button>
    </div>
  `;
  return card;
}

function render() {
  const grid = document.getElementById('sections');
  grid.innerHTML = '';

  const groupData = groups[currentGroup] || {};
  const entries = Object.entries(groupData);

  const pinned = entries.filter(([title]) => pinnedSections[title]);
  const unpinned = entries.filter(([title]) => !pinnedSections[title]);

  pinned.forEach(([title, messages]) => {
    const card = createCard(title, messages, true);
    grid.appendChild(card);
  });

  if (pinned.length > 0 && unpinned.length > 0) {
    const separator = document.createElement('div');
    separator.style.cssText = `
      height: 2px;
      background: repeating-linear-gradient(90deg, var(--color-primary), var(--color-primary) 10px, transparent 10px, transparent 20px);
      margin: 10px 0;
      grid-column: 1 / -1;
    `;
    grid.appendChild(separator);
  }

  unpinned.forEach(([title, messages]) => {
    const card = createCard(title, messages, false);
    grid.appendChild(card);
  });
}

function generateEmojiMenu() {
  let html = '';
  Object.entries(emojiData).forEach(([cat, emojis]) => {
    html += `<div class='emoji-category'><div class='emoji-category-title'>${cat}</div>`;
    emojis.forEach(e => {
      html += `<span class='emoji-item' onclick='insertEmoji("${e}")'>${e}</span>`;
    });
    html += `</div>`;
  });
  return html;
}

function refreshAllEmojiMenus() {
  document.querySelectorAll('.emoji-menu').forEach(menu => {
    const search = menu.querySelector('input');
    menu.innerHTML = '';
    if (search) menu.appendChild(search);
    menu.innerHTML += generateEmojiMenu();
  });
}

function setActiveTextId(id) { currentTextId = id; }
function updateMessage(section, i, val) { groups[currentGroup][section][i] = val; saveToLocalStorage(); }
function addMessage(section) { groups[currentGroup][section].push('Nova saudação...'); saveToLocalStorage(); render(); }
function removeMessage(section) { if (groups[currentGroup][section].length > 1) { groups[currentGroup][section].pop(); saveToLocalStorage(); render(); } }
function removeSection(section) { delete groups[currentGroup][section]; delete mediaStorage[section]; localStorage.setItem('mediaStorage', JSON.stringify(mediaStorage)); saveToLocalStorage(); render(); }
function addSection() {
  const name = document.getElementById('newSection').value.trim();
  if (name && !groups[currentGroup][name]) {
    groups[currentGroup][name] = ['Nova saudação...'];
    document.getElementById('newSection').value = '';
    saveToLocalStorage();
    render();
  }
}
function importData() { document.getElementById('fileInput').click(); }
function handleFile(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    const imported = JSON.parse(reader.result);
    
    emojiData = imported.emojiData || { "Carinhas": ["😀", "😃", "😁", "😂"] };
    if (imported.primaryColor) { changePrimaryColor(imported.primaryColor); }
    if (imported.themeMode) {
      localStorage.setItem('themeMode', imported.themeMode);
      document.getElementById('themeSelector').value = imported.themeMode;
      applyTheme(imported.themeMode);
    }
    saveToLocalStorage();
    render();
  };
  reader.readAsText(file);
}

function openEmojiManager() {
  renderEmojiManager();
  document.getElementById('emojiManagerModal').style.display = 'flex';
}
function closeEmojiManager() {
  document.getElementById('emojiManagerModal').style.display = 'none';
}

function renderEmojiManager() {
  const container = document.getElementById('emojiCategories');
  container.innerHTML = '';
  Object.entries(emojiData).forEach(([category, emojis]) => {
    const div = document.createElement('div');
    div.style.marginBottom = '20px';
    div.innerHTML = `
      <input type="text" value="${category}" onchange="renameEmojiCategory('${category}', this.value)" style="margin-bottom:5px; padding:5px; width:80%;">
      <div>${emojis.map((e, i) => `<span style="font-size:24px; cursor:pointer; margin:5px;" onclick="removeEmoji('${category}', ${i})">${e}</span>`).join('')}</div>
      <input type="text" placeholder="Novo emoji..." id="newEmoji-${category}" style="margin-top:5px; padding:5px; width:70%;">
      <button class="emoji-button" onclick="addEmoji('${category}')">Adicionar Emoji</button>
      <button class="emoji-button" onclick="deleteEmojiCategory('${category}')">Excluir Categoria</button>
    `;
    container.appendChild(div);
  });
}

function addEmojiCategory() {
  const name = prompt("Nome da nova categoria:");
  if (name && !emojiData[name]) {
    emojiData[name] = [];
    renderEmojiManager();
    refreshAllEmojiMenus();
    saveToLocalStorage();
  }
}

function renameEmojiCategory(oldName, newName) {
  if (oldName !== newName && newName) {
    emojiData[newName] = emojiData[oldName];
    delete emojiData[oldName];
    renderEmojiManager();
    refreshAllEmojiMenus();
    saveToLocalStorage();
  }
}

function deleteEmojiCategory(category) {
  if (confirm(`Excluir a categoria "${category}"?`)) {
    delete emojiData[category];
    renderEmojiManager();
    refreshAllEmojiMenus();
    saveToLocalStorage();
  }
}

function addEmoji(category) {
  const input = document.getElementById(`newEmoji-${category}`);
  const emoji = input.value.trim();
  if (emoji) {
    emojiData[category].push(emoji);
    input.value = '';
    renderEmojiManager();
    refreshAllEmojiMenus();
    saveToLocalStorage();
  }
}

function removeEmoji(category, index) {
  emojiData[category].splice(index, 1);
  renderEmojiManager();
  refreshAllEmojiMenus();
  saveToLocalStorage();
}

function wrapText(id, wrapper) {
  if (!id) return;
  const el = document.getElementById(id);
  const start = el.selectionStart;
  const end = el.selectionEnd;
  const selected = el.value.substring(start, end);
  el.setRangeText(wrapper + selected + wrapper);
  el.focus();
  el.setSelectionRange(start + wrapper.length, end + wrapper.length);
  updateDataFromElement(el);
}

function updateDataFromElement(el) {
  const [section, index] = el.id.split('-');
  updateMessage(section, Number(index), el.value);
}

function toggleEmojiMenu(button) {
  const menu = button.nextElementSibling;
  const isVisible = menu.classList.contains('show');
  document.querySelectorAll('.emoji-menu').forEach(m => m.classList.remove('show'));
  if (!isVisible) menu.classList.add('show');
}


function copySelectedText() {
  if (!currentTextId) return showToast('Selecione uma caixa!');
  const el = document.getElementById(currentTextId);
  el.select();
  document.execCommand('copy');
  showToast('Texto copiado!');
  el.setSelectionRange(el.selectionEnd, el.selectionEnd); // desfaz seleção visual
}


function insertEmoji(emoji) {
  if (!currentTextId) return showToast('Selecione uma caixa!');
  const el = document.getElementById(currentTextId);
  const start = el.selectionStart;
  const end = el.selectionEnd;
  el.value = el.value.slice(0, start) + emoji + el.value.slice(end);
  el.focus();
  el.setSelectionRange(start + emoji.length, start + emoji.length);
  updateDataFromElement(el);
}


function changePrimaryColor(color) {
  const currentColor = localStorage.getItem('primaryColor') || '#f57c00';
  if (currentColor === color) return; // 🚫 Não faz nada se não mudou
  document.documentElement.style.setProperty('--color-primary', color);
  localStorage.setItem('primaryColor', color);
  saveState();
}
    

// --- REDIFINIÇÃO AVANÇADA ---
function resetConfig() {
  const op = prompt('Escolha uma opção:\n1 - Redefinir grupo atual\n2 - Redefinir tudo\n3 - Redefinir apenas o tema');
  if (op === '1') {
    delete groups[currentGroup];
    groups[currentGroup] = {};
    saveToLocalStorage();
    render();
    showToast('Grupo redefinido.');
  } else if (op === '2') {
    localStorage.clear();
    location.reload();
  } else if (op === '3') {
    localStorage.removeItem('themeMode');
    location.reload();
  }
}

function filterSections() {
  const query = document.getElementById('searchBox').value.toLowerCase();
  document.querySelectorAll('.card').forEach(card => {
    const title = card.querySelector('h3').innerText.toLowerCase();
    card.style.display = title.includes(query) ? '' : 'none';
  });
}

function filterEmojis(input) {
  const query = input.value.toLowerCase();
  const items = input.parentElement.querySelectorAll('.emoji-item');
  items.forEach(item => {
    item.style.display = item.textContent.includes(query) ? 'inline-block' : 'none';
  });
}

function applyTheme(mode) {
  document.body.classList.remove('light-mode', 'dark-mode');
  if (mode === 'light') {
    document.body.classList.add('light-mode');
  } else if (mode === 'dark') {
    document.body.classList.add('dark-mode');
  } else {
    const hour = new Date().getHours();
    if (hour >= 7 && hour < 18) {
      document.body.classList.add('light-mode');
    } else {
      document.body.classList.add('dark-mode');
    }
  }
}


function changeTheme(mode) {
  const currentTheme = localStorage.getItem('themeMode') || 'auto';
  if (currentTheme === mode) return; // 🚫 Não faz nada se não mudou
  localStorage.setItem('themeMode', mode);
  saveState();
  applyTheme(mode);
}
    

function loadTheme() {
  const savedTheme = localStorage.getItem('themeMode') || 'auto';
  document.getElementById('themeSelector').value = savedTheme;
  applyTheme(savedTheme);
}

function autoUpdateTheme() {
  setInterval(() => {
    const mode = localStorage.getItem('themeMode') || 'auto';
    if (mode === 'auto') applyTheme('auto');
  }, 60000);
}

window.addEventListener('click', function(e) {
  if (!e.target.closest('.emoji-dropdown')) {
    document.querySelectorAll('.emoji-menu').forEach(m => m.classList.remove('show'));
  }
});



document.addEventListener('mouseup', () => {
  if (selectionBox) selectionBox.remove();
  isSelecting = false;
});


function exportarConfiguracoes() {
  const midiasPorGrupo = {};

  for (const [grupo, secoes] of Object.entries(groups)) {
    midiasPorGrupo[grupo] = {};
    for (const secao in secoes) {
      if (mediaStorage[secao]) {
        midiasPorGrupo[grupo][secao] = mediaStorage[secao];
      }
    }
  }

  const configuracoes = {
    grupos: groups,
    grupoAtual: currentGroup,
    emojis: emojiData,
    midias: midiasPorGrupo,
    fixadas: pinnedSections,
    tema: localStorage.getItem("themeMode") || "auto",
    corPrimaria: localStorage.getItem("primaryColor") || "#f57c00",
    apiKeysIA: JSON.parse(localStorage.getItem("api_keys_ia") || "{}")
  };

  const blob = new Blob([JSON.stringify(configuracoes, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");

  const agora = new Date();
  const dataHora = agora.toISOString().replace(/T/, '_').replace(/:/g, '-').replace(/\..+/, '');
  a.download = `configuracoes_saudacoes_${dataHora}.json`;

  a.href = url;
  a.click();
}


function importarConfiguracoes() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = () => {
      try {
        const config = JSON.parse(reader.result);

        if (config.tema) {
          localStorage.setItem("themeMode", config.tema);
          document.getElementById("themeSelector").value = config.tema;
          applyTheme(config.tema);
        }

        if (config.corPrimaria) {
          changePrimaryColor(config.corPrimaria);
        }

        if (config.grupos) groups = config.grupos;
        if (config.grupoAtual) {
          currentGroup = config.grupoAtual;
          localStorage.setItem("currentGroup", currentGroup);
        }

        if (config.emojis) emojiData = config.emojis;
        if (config.fixadas) pinnedSections = config.fixadas;

        // Reconstrói o mediaStorage
        mediaStorage = {};
        if (config.midias) {
          for (const [grupo, secoes] of Object.entries(config.midias)) {
            for (const [secao, midias] of Object.entries(secoes)) {
              mediaStorage[secao] = midias;
            }
          }
        }

                if (config.apiKeysIA) {
          apiKeys = config.apiKeysIA;
          localStorage.setItem("api_keys_ia", JSON.stringify(apiKeys));
        }
saveToLocalStorage();
populateGroupSelector(); // ← ESSENCIAL PARA EXIBIR TODOS OS GRUPOS
        render();
      } catch (err) {
        showToast("Erro ao importar configurações: " + err.message);
      }
    };

    reader.readAsText(file);
  };

  input.click();
}

window.onload = () => {

document.addEventListener('click', function(e) {
  const isInTextarea = e.target.closest('textarea.text-editable-area');
  const isInActions = e.target.closest('.actions');

  if (!isInTextarea && !isInActions) {
    currentTextId = null;
  }
});


  loadFromLocalStorage();       // 1. Carrega os dados
  populateGroupSelector();      // 2. Preenche a lista suspensa dos grupos
  loadTheme();                  // 3. Aplica o tema
  render();                     // 4. Renderiza as caixas
  autoUpdateTheme();            // 5. Atualiza o tema dinamicamente (opcional)
}

function excluirSelecionadas() {
  selectedSections.forEach(title => {
    delete groups[currentGroup][title];
  });
  selectedSections.clear();
  saveToLocalStorage();
  render();
  showToast('Seções selecionadas foram excluídas.');
}



function renameSection(oldName) {
  const newName = prompt("Digite o novo nome para a saudação:", oldName);
  if (newName && newName !== oldName) {
    if (groups[currentGroup][newName]) {
      showToast("Já existe uma saudação com esse nome!");
      return;
    }
    groups[currentGroup][newName] = groups[currentGroup][oldName];
    delete groups[currentGroup][oldName];

    // Corrige a perda de mídias ao renomear
    if (mediaStorage[oldName]) {
      mediaStorage[newName] = mediaStorage[oldName];
      delete mediaStorage[oldName];
    }
     if (pinnedSections[oldName]) {
  pinnedSections[newName] = pinnedSections[oldName];
  delete pinnedSections[oldName];
  localStorage.setItem('pinnedSections', JSON.stringify(pinnedSections));
}

    saveToLocalStorage();
    render();
  }
}



function triggerFileInput(section) {
  document.getElementById(`input-${section}`).click();
}

function handleMediaUpload(e, section) {
  const files = Array.from(e.target.files);
  processMediaFiles(files, section);
}

function handleMediaDrop(e, section) {
  e.preventDefault();
  const files = Array.from(e.dataTransfer.files);
  processMediaFiles(files, section);
}

function processMediaFiles(files, section) {
  mediaStorage[section] ||= [];

  files.forEach(file => {
    // Use o nome do arquivo diretamente como referência.
    const fileUrl = 'file:///' + file.name.replace(/\\/g, '/');

    mediaStorage[section].push({
      name: file.name,
      type: file.type,
      data: fileUrl
    });
  });

  render();
}


function addMediaUrl(section) {
  const url = prompt("Cole a URL do arquivo (imagem, vídeo, áudio, PDF):");
  if (!url) return;
  const name = url.split('/').pop().split('?')[0] || 'arquivo';
  let type = '';
  const ext = name.split('.').pop().toLowerCase();
  if (ext === 'jpg' || ext === 'jpeg') type = 'image/jpeg';
  else if (ext === 'png') type = 'image/png';
  else if (ext === 'gif') type = 'image/gif';
  else if (ext === 'webp') type = 'image/webp';
  else if (ext === 'mp4') type = 'video/mp4';
  else if (ext === 'webm') type = 'video/webm';
  else if (ext === 'ogg') type = 'video/ogg';
  else if (ext === 'mp3') type = 'audio/mpeg';
  else if (ext === 'wav') type = 'audio/wav';
  else if (ext === 'pdf') type = 'application/pdf';
  mediaStorage[section] ||= [];
  mediaStorage[section].push({ name, type, data: url });
  render();
}

function generateMediaPreview(section) {
  const items = mediaStorage[section] || [];

  return items.map((item, index) => {
    const url = (item.data || '').trim();
    const type = item.type || '';
    const name = item.name || 'sem nome';

    const copyLinkButton = `<button onclick="copyLink('${url}')" title="Copiar link da mídia">🔗</button>`;
    const zoomButton = `<button onclick="window.open('${url}', '_blank')" title="Abrir em nova aba">🔍</button>`;
    const deleteButton = `<button onclick="deleteMedia('${section}', ${index})" title="Excluir">❌</button>`;

    const isYouTube = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/.exec(url);
    const isImage = type.startsWith('image/') || /\.(jpe?g|png|gif|webp)$/i.test(url);
    const isVideo = type.startsWith('video/') || /\.(mp4|webm|ogg)$/i.test(url);
    const isAudio = type.startsWith('audio/') || /\.(mp3|wav|ogg)$/i.test(url);
    const isPDF = type === 'application/pdf' || /\.pdf$/i.test(url);

    let mediaTag = '';

    if (!url) {
      // ❌ Mídia sem caminho → Erro (vermelho)
      mediaTag = `<div class="status-shape shape-red">Erro!<br/>Mídia não vinculada</div>`;
    } else if (isYouTube) {
      const videoId = isYouTube[1];
      mediaTag = `<iframe width="280" height="160" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
    } else if (isImage) {
      mediaTag = `<img src="${url}" style="max-height:120px;" style="max-height:120px;" onerror="this.outerHTML = \`<div class=\'status-shape shape-yellow\' style=\'flex-direction: column;\'><svg width=\'40\' height=\'40\' viewBox=\'0 0 24 24\' fill=\'white\'><path d=\'M1 21h22L12 2 1 21zm13-2h-2v-2h2v2zm0-4h-2v-4h2v4z\'/></svg><div style=\'margin-top: 4px;\'>Mídia Ausente</div></div>\`;">`;
    } else if (isVideo) {
      mediaTag = `<video controls src="${url}" style="max-height:160px;" style="max-height:160px;" onerror="this.outerHTML = \`<div class=\'status-shape shape-yellow\' style=\'flex-direction: column;\'><svg width=\'40\' height=\'40\' viewBox=\'0 0 24 24\' fill=\'white\'><path d=\'M1 21h22L12 2 1 21zm13-2h-2v-2h2v2zm0-4h-2v-4h2v4z\'/></svg><div style=\'margin-top: 4px;\'>Mídia Ausente</div></div>\`;"></video>`;
    } else if (isAudio) {
      mediaTag = `<audio controls src="${url}" style="width:200px;" style="max-height:30px;" onerror="this.outerHTML = \`<div class=\'status-shape shape-yellow\' style=\'flex-direction: column;\'><svg width=\'40\' height=\'40\' viewBox=\'0 0 24 24\' fill=\'white\'><path d=\'M1 21h22L12 2 1 21zm13-2h-2v-2h2v2zm0-4h-2v-4h2v4z\'/></svg><div style=\'margin-top: 4px;\'>Mídia Ausente</div></div>\`;"></audio>`;
    } else if (isPDF) {
      mediaTag = `<embed src="${url}" type="application/pdf" width="100%" height="200px">`;
    } else if (url.startsWith('file:///')) {
      // ⚠️ Caminho local sem tipo reconhecido → Aviso (amarelo)
      mediaTag = `<div class="status-shape shape-yellow">Alerta!<br/>Mídia Ausente</div>`;
    } else {
      // ✅ URL válida mas tipo desconhecido → Sucesso (verde)
      mediaTag = `<div class="status-shape shape-green">Tudo Certo!<br/>Mídia vinculada</div>`;
    }

    return `<div style="position: relative; display: inline-block; margin-bottom: 10px;">
              ${mediaTag}
              <div style="position: absolute; top: -36px; left: 90px; display: flex; gap: 4px; flex-direction: column; transform: scale(0.7);">
                ${zoomButton}
                ${copyLinkButton}
                ${deleteButton}
              </div>
            </div>`;
  }).join('');
}

function copyLink(link) {
  navigator.clipboard.writeText(link).then(() => {
    showToast('Link copiado!');
  }).catch(err => {
    showToast('Erro ao copiar o link: ' + err);
  });
}




function deleteMedia(section, index) {
  if (!mediaStorage[section]) return;
  mediaStorage[section].splice(index, 1);
  localStorage.setItem('mediaStorage', JSON.stringify(mediaStorage));
  render();
}

function downloadMedia(dataUrl, filename) {
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  a.click();
}

async function copyMediaToClipboard(dataUrl, type) {
  if (!type.startsWith("image/")) {
    showToast("Apenas imagens podem ser copiadas para a área de transferência.");
    return;
  }

  try {
    const response = await fetch(dataUrl);
    const blob = await response.blob();
    await navigator.clipboard.write([
      new ClipboardItem({ [type]: blob })
    ]);
    showToast('Imagem copiada para a área de transferência!');
  } catch (err) {
    showToast('Erro ao copiar imagem: ' + err.message);
  }
}


document.querySelectorAll('textarea').forEach(el => {
  el.addEventListener('mousedown', e => e.stopPropagation());
});



function addMediaFromPath(section) {
  let path = prompt("Cole o caminho local completo do arquivo (ex: C:\\Users\\Lucas\\Downloads\\imagem.png):");
  if (!path) return;
  
  // Remove aspas duplas no início e no fim, se existirem
  path = path.trim().replace(/^"(.*)"$/, '$1');

  const name = path.split(/[\\\/]/).pop();
  const fileUrl = 'file:///' + path.replace(/\\/g, '/');

  mediaStorage[section] ||= [];
  mediaStorage[section].push({ name, type: '', data: fileUrl });

  saveToLocalStorage();
  render();
  
}
document.addEventListener("keydown", function (e) {
  if (e.ctrlKey && e.key.toLowerCase() === "f") {
    e.preventDefault();
    showToast("Ação bloqueada."); // ou alert("Ação bloqueada.");
  }
});

</script>
<!-- SortableJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js">
new Sortable(document.getElementById('sections'), {
  handle: '.drag-handle',
  animation: 150,
  ghostClass: 'drag-ghost',
  filter: '.pinned',
  onMove: evt => !evt.related.classList.contains('pinned'),
  onMove: evt => {
    return !evt.related.classList.contains('pinned');
  }
});

document.querySelectorAll('textarea').forEach(el => {
  el.addEventListener('mousedown', e => e.stopPropagation());
});

</script>
<script>
let pinnedSections = JSON.parse(localStorage.getItem('pinnedSections') || '{}');
let selectedSections = new Set();

function togglePin(section) {
  pinnedSections[section] = !pinnedSections[section];
  localStorage.setItem('pinnedSections', JSON.stringify(pinnedSections));
  render();
}

function toggleSectionSelection(section) {
  if (selectedSections.has(section)) {
    selectedSections.delete(section);
  } else {
    selectedSections.add(section);
  }
  render();
}

function moveSelectedSections() {
  const items = Array.from(selectedSections);
  if (items.length === 0) {
    showToast("Nenhuma saudação selecionada.");
    return;
  }

  const groupNames = Object.keys(groups).filter(g => g !== currentGroup);
  const options = groupNames.map((g, i) => `${i + 1} - ${g}`).join('\n');
  const choice = prompt(`Mover saudação(s) para:
${options}
0 - Novo grupo`);

  if (choice === null) return;

  let destino = null;
  if (choice === "0") {
    const nomeNovo = prompt("Nome do novo grupo:");
    if (!nomeNovo) return;
    groups[nomeNovo] = {};
    destino = nomeNovo;
  } else {
    const idx = parseInt(choice) - 1;
    if (!groupNames[idx]) return showToast("Grupo inválido.");
    destino = groupNames[idx];
  }

  items.forEach(section => {
    groups[destino][section] = groups[currentGroup][section];
    delete groups[currentGroup][section];
    selectedSections.delete(section);
  });

  saveToLocalStorage();
  render();
}

  // Inicializa a funcionalidade de arrastar nas caixas
  new Sortable(document.getElementById('sections'), {
  handle: '.drag-handle',
  animation: 150,
  ghostClass: 'drag-ghost',
  onMove: evt => {
    const isPinned = evt.related.classList.contains('pinned');
    return !isPinned;
  }
});

document.querySelectorAll('textarea').forEach(el => {
  el.addEventListener('mousedown', e => e.stopPropagation());
});

</script>
<script>
let clipboardSections = [];

document.addEventListener('keydown', function(e) {
  const tag = document.activeElement.tagName;
  if (tag === 'TEXTAREA' || tag === 'INPUT') return;

  if (!e.ctrlKey) return;

  const key = e.key.toLowerCase();
  e.preventDefault();

  if (key === 'a') {
    document.querySelectorAll('.card').forEach(card => {
      const title = card.querySelector('h3')?.innerText;
      if (title) selectedSections.add(title);
    });
    render();
  }

  if (key === 'c') {
    clipboardSections = Array.from(selectedSections).map(title => ({
      title,
      messages: [...groups[currentGroup][title]]
    }));
    showToast('Seções copiadas!');
  }

  if (key === 'x') {
    clipboardSections = Array.from(selectedSections).map(title => ({
      title,
      messages: [...groups[currentGroup][title]]
    }));
    selectedSections.forEach(title => {
      delete groups[currentGroup][title];
    });
    selectedSections.clear();
    saveToLocalStorage();
    render();
    showToast('Seções recortadas!');
  }

  if (key === 'v') {
    if (clipboardSections.length === 0) {
      showToast('Nada copiado ou recortado.');
      return;
    }

    clipboardSections.forEach(({ title, messages }) => {
      let newTitle = title;
      let suffix = 1;
      while (groups[currentGroup][newTitle]) {
        const padded = String(suffix).padStart(2, '0');
        newTitle = `${title} (${padded})`;
        suffix++;
      }
      groups[currentGroup][newTitle] = [...messages];
    });

    saveToLocalStorage();
    render();
    showToast('Seções coladas!');
  }
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Delete' || e.key === 'Backspace') {
    if (selectedSections.size === 0) return;

    const confirmDelete = confirm(`Deseja apagar ${selectedSections.size} saudação(ões) selecionada(s)?`);
    if (!confirmDelete) return;

    selectedSections.forEach(title => {
      delete groups[currentGroup][title];
    });
    selectedSections.clear();
    saveToLocalStorage();
    render();
    showToast('Seções excluídas.');
  }
});

document.querySelectorAll('textarea').forEach(el => {
  el.addEventListener('mousedown', e => e.stopPropagation());
});

</script>
<footer id="customFooter" style="text-align:center; padding: 5px; font-size: 0.9em; color: white; background: var(--color-primary);padding-left: 425px;padding-right: 425px;position: fixed;
  bottom: 0px;left: 0px; right: 0px;margin-top: 35px; z-index: 1000;box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);">
  © <span id="ano">2025</span> <strong>DEV.associados</strong> — Todos os direitos reservados.
</footer>
<script>
  document.getElementById("ano").textContent = new Date().getFullYear();
</script>
<!-- POPUP DE VISUALIZAÇÃO -->
<!-- Modal Base64 -->
<div id="dialogoBase64" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:10000;">
<div style="background:var(--color-background); color:var(--color-text); padding:20px; border-radius:10px; max-width:500px; width:90%; position:relative;">
<h3>Importar mídia via Base64</h3>
<textarea class="text-editable-area" id="base64Input" placeholder="Cole o código base64 aqui..." style="width:100%; height:150px; margin-bottom:10px;"></textarea>
<div style="display:flex; justify-content: flex-end; gap: 10px;">
<button onclick="confirmarImportacaoBase64()">Confirmar</button>
<button onclick="fecharDialogoBase64()">Cancelar</button>
</div>
</div>
</div>
<script>
function abrirDialogoBase64() {
  if (!currentTextId) return showToast('Selecione uma caixa de texto primeiro.');
  document.getElementById('dialogoBase64').style.display = 'flex';
}

function fecharDialogoBase64() {
  document.getElementById('dialogoBase64').style.display = 'none';
  document.getElementById('base64Input').value = '';
}

function confirmarImportacaoBase64() {
  const base64 = document.getElementById('base64Input').value.trim();
  if (!base64) return showToast("Cole um código base64 válido.");
  if (!currentTextId) return showToast("Selecione uma caixa de texto primeiro.");
  const [section] = currentTextId.split('-');
  const matches = base64.match(/^data:(.*?);base64,/);
  if (!matches) {
    showToast("Formato inválido. Certifique-se de incluir o prefixo data:...");
    return;
  }
  const mimeType = matches[1];
  mediaStorage[section] ||= [];
  mediaStorage[section].push({
    name: 'importado.' + mimeType.split('/')[1],
    type: mimeType,
    data: base64
  });
  localStorage.setItem('mediaStorage', JSON.stringify(mediaStorage));
  fecharDialogoBase64();
  render();
}

document.querySelectorAll('textarea').forEach(el => {
  el.addEventListener('mousedown', e => e.stopPropagation());
});

</script>
<script>
function baixarPaginaHTML() {
  fetch(window.location.href)
    .then(response => response.text())
    .then(html => {
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const nomeArquivo = 'pagina_DEV_associados_' + new Date().toISOString().slice(0,19).replace(/[:T]/g, '-') + '.html';
      a.href = url;
      a.download = nomeArquivo;
      a.click();
      URL.revokeObjectURL(url);
    })
    .catch(err => showToast("Erro ao baixar a página: " + err.message));
}
</script>
<script>
const historyStack = [];
const redoStack = [];

function saveState() {
  const snapshot = JSON.stringify({
    groups,
    currentGroup,
    emojiData,
    mediaStorage,
    pinnedSections: { ...pinnedSections },
    selectedSections: Array.from(selectedSections),
    theme: localStorage.getItem('themeMode'),
    primaryColor: localStorage.getItem('primaryColor')
  });
  historyStack.push(snapshot);
  if (historyStack.length > 100) historyStack.shift();
  redoStack.length = 0; // Limpa o redo ao criar novo estado
}


function loadState(snapshot) {
  const state = JSON.parse(snapshot);
  groups = state.groups;
  currentGroup = state.currentGroup;
  emojiData = state.emojiData;
  mediaStorage = state.mediaStorage;
  pinnedSections = state.pinnedSections;
  selectedSections = new Set(state.selectedSections);
  
  // 🌓 Restaurando tema
  if (state.theme) {
    localStorage.setItem('themeMode', state.theme);
    document.getElementById('themeSelector').value = state.theme;
    applyTheme(state.theme);
  }

  // 🎨 Restaurando cor primária
  if (state.primaryColor) {
    document.documentElement.style.setProperty('--color-primary', state.primaryColor);
    localStorage.setItem('primaryColor', state.primaryColor);
  }

  saveToLocalStorage();
  render();
}


function undo() {
  if (historyStack.length === 0) {
    showToast('Nada para desfazer.');
    return;
  }
  const current = JSON.stringify({
    groups,
    theme: localStorage.getItem('themeMode'),
    primaryColor: localStorage.getItem('primaryColor'),
    currentGroup,
    emojiData,
    mediaStorage,
    pinnedSections: { ...pinnedSections },
    selectedSections: Array.from(selectedSections)
  });
  redoStack.push(current);
  const previous = historyStack.pop();
  loadState(previous);
  showToast('Desfeito.');
}

function redo() {
  if (redoStack.length === 0) {
    showToast('Nada para refazer.');
    return;
  }
  const current = JSON.stringify({
    groups,
    theme: localStorage.getItem('themeMode'),
    primaryColor: localStorage.getItem('primaryColor'),
    currentGroup,
    emojiData,
    mediaStorage,
    pinnedSections: { ...pinnedSections },
    selectedSections: Array.from(selectedSections)
  });
  historyStack.push(current);
  const next = redoStack.pop();
  loadState(next);
  showToast('Refeito.');
}

// 🔗 Hooka todas funções que alteram dados
const functionsToHook = [
  addSection, removeSection, addMessage, removeMessage,
  renameSection, renameGroup, createGroup, deleteGroup,
  togglePin, toggleSectionSelection, moveSelectedSections,
  addEmoji, removeEmoji, renameEmojiCategory, addEmojiCategory, deleteEmojiCategory,
  addMediaUrl, addMediaFromPath, deleteMedia, handleMediaUpload,
  importarConfiguracoes, excluirSelecionadas, resetConfig
,
  changeTheme,
  changePrimaryColor];

functionsToHook.forEach(fn => {
  const original = fn;
  window[fn.name] = function(...args) {
    saveState();
    return original.apply(this, args);
  };
});

// Também hooka updateMessage (edição de texto)
const originalUpdateMessage = updateMessage;
updateMessage = function(section, i, val) {
  saveState();
  return originalUpdateMessage(section, i, val);
};
</script>

<div id="textContextMenu" style="
  display: none;
  position: absolute;
  z-index: 9999;
  background: var(--color-background);
  color: var(--color-text);
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  padding: 6px;
  font-size: 13px;
">
<div class="menu-item" onclick="textContextAction('selectAll')">Selecionar Tudo</div>
<div class="menu-item" onclick="textContextAction('copy')">Copiar</div>
<div class="menu-item" onclick="textContextAction('cut')">Recortar</div>
<div class="menu-item" onclick="textContextAction('paste')">Colar</div>
<div class="menu-item" onclick="textContextAction('delete')">Excluir</div>
<hr style="margin: 6px 0; border: none; border-top: 1px solid #eee;"/>
<div class="menu-item" onclick="textContextAction('undo')">Desfazer</div>
<div class="menu-item" onclick="textContextAction('redo')">Refazer</div>
</div>
<script>
let activeTextElement = null;
let textHistory = new Map();
let redoHistory = new Map();

document.addEventListener('click', e => {
  document.getElementById('textContextMenu').style.display = 'none';
});

document.addEventListener('contextmenu', e => {
  if (e.target.matches('textarea.text-editable-area')) {
    e.preventDefault();
    activeTextElement = e.target;

    const menu = document.getElementById('textContextMenu');
    menu.style.top = `${e.pageY}px`;
    menu.style.left = `${e.pageX}px`;
    menu.style.display = 'block';

    const id = activeTextElement.id;
    if (!textHistory.has(id)) {
      textHistory.set(id, [activeTextElement.value]);
      redoHistory.set(id, []);
    }
  }
});

async function textContextAction(action) {
  const el = activeTextElement;
  const id = el.id;
  if (!el) return;

  el.focus();

  if (action === 'selectAll') {
    el.select();
  }

  if (action === 'copy') {
    if (el.selectionStart !== el.selectionEnd) {
      document.execCommand('copy');
    } else {
      el.select();
      document.execCommand('copy');
      el.setSelectionRange(el.selectionEnd, el.selectionEnd);
    }
  }

  if (action === 'cut') {
    document.execCommand('cut');
    saveTextSnapshot(id);
  }

  if (action === 'paste') {
    try {
      const text = await navigator.clipboard.readText();
      const start = el.selectionStart;
      const end = el.selectionEnd;
      el.setRangeText(text, start, end, 'end');
      saveTextSnapshot(id, el.value);
      updateDataFromElement(el);
    } catch (err) {
      showToast("Permissão de leitura da área de transferência negada.");
    }
  }

  if (action === 'delete') {
    el.value = '';
    saveTextSnapshot(id);
    updateDataFromElement(el);
  }

  if (action === 'undo') {
    const stack = textHistory.get(id) || [];
    const redoStack = redoHistory.get(id) || [];
    if (stack.length > 1) {
      const last = stack.pop();
      redoStack.push(last);
      el.value = stack[stack.length - 1];
      updateDataFromElement(el);
    }
  }

  if (action === 'redo') {
    const redoStack = redoHistory.get(id) || [];
    if (redoStack.length > 0) {
      const value = redoStack.pop();
      (textHistory.get(id) || []).push(value);
      el.value = value;
      updateDataFromElement(el);
    }
  }

  document.getElementById('textContextMenu').style.display = 'none';
}


document.addEventListener('input', e => {
  if (e.target.matches('textarea.text-editable-area')) {
    const id = e.target.id;
    saveTextSnapshot(id, e.target.value);
  }
});

function saveTextSnapshot(id, value = null) {
  if (!textHistory.has(id)) textHistory.set(id, []);
  const stack = textHistory.get(id);
  const current = value !== null ? value : document.getElementById(id).value;
  if (stack[stack.length - 1] !== current) {
    stack.push(current);
    if (stack.length > 100) stack.shift();
  }
  redoHistory.set(id, []);
}
</script>
<!-- Menu de contexto para mídias -->

<script>
document.addEventListener("keydown", function (e) {
  if (
    e.key === "F12" ||
    (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
    (e.ctrlKey && (e.key === "U" || e.key === "S")) ||
    
  ) {
    e.preventDefault();
    e.stopPropagation();
    showToast("Ação bloqueada.");
  }
});

// Permitir clique direito apenas em imagens
document.addEventListener("contextmenu", function (e) {
  if (e.target.tagName !== 'IMG') {
    e.preventDefault();
  }
});
</script>


<script>
(function() {if (false) {
  let checkDevTools = () => {
    const start = performance.now();
    debugger;
    const end = performance.now();
    if (end - start > 100) {
      window.location.href = "about:blank";
    }
  };
  setInterval(checkDevTools, 1000);
})();
</script>


<script>
// Bloqueia clique direito fora de imagens
document.addEventListener("contextmenu", function (e) {if (false) {
  if (e.target.tagName !== 'IMG') {
    e.preventDefault();
  }
});

// Bloqueia atalhos de desenvolvedor e salvar
document.addEventListener("keydown", function (e) {if (false) {
  if (
    e.key === "F12" ||
    (e.ctrlKey && e.shiftKey && ["I", "J"].includes(e.key)) ||
    (e.ctrlKey && ["U", "S"].includes(e.key))
  ) {
    e.preventDefault();
    showToast("Ação bloqueada.");
  }
});

</script>





<script>
let apiKeys = JSON.parse(localStorage.getItem("api_keys_ia")) || {
  OpenAI: "",
  Gemini: ""
};

function abrirPopupIA() {
  selectedSections.clear();
  currentTextId = null;
  render();

  document.getElementById("popupIA").style.display = "flex";
  carregarApiKey();
}


function fecharPopupIA() {
  document.getElementById("popupIA").style.display = "none";
  document.getElementById("respostaIA").innerText = "";
}

function salvarApiKey() {
  const provider = document.getElementById("providerSelector").value;
  const key = document.getElementById("apiKeyInput").value.trim();

  if (!key) {
    showToast("API Key não pode ser vazia.");
    return;
  }

  apiKeys[provider] = key;
  localStorage.setItem("api_keys_ia", JSON.stringify(apiKeys));
  showToast(`API Key de ${provider} salva com sucesso!`);
}

async function enviarPromptIA() {
  const provider = document.getElementById("providerSelector").value;
  const key = apiKeys[provider] || "";
  const prompt = document.getElementById("userPromptIA").value.trim();
  const respostaDiv = document.getElementById("respostaIA");

  if (!key) {
    showToast(`API Key de ${provider} não configurada.`);
    return;
  }
  if (!prompt) {
    showToast("Digite sua mensagem.");
    return;
  }

  respostaDiv.innerText = "💬 Gerando resposta...";

  try {
    let response;
    if (provider === "OpenAI") {
      response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${key}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: prompt }],
          temperature: 0.7
        })
      });

      const data = await response.json();
      respostaDiv.innerText = data.choices?.[0]?.message?.content || JSON.stringify(data);

    } else if (provider === "Gemini") {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      const data = await response.json();
      const output = data.candidates?.[0]?.content?.parts?.[0]?.text;
      respostaDiv.innerText = output || JSON.stringify(data);

    } else {
      respostaDiv.innerText = "🔧 Provedor não implementado.";
    }

  } catch (err) {
    respostaDiv.innerText = "❌ Erro: " + err.message;
  }
}

function carregarApiKey() {
  const provider = document.getElementById("providerSelector").value;
  const key = apiKeys[provider] || "";
  document.getElementById("apiKeyInput").value = key;
}

</script>


<!-- Popup de Inserção de IA em Saudação -->
<div id="popupInsercaoIA" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
    background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:10000;">
  <div style="background:var(--color-background); color:var(--color-text); padding:20px; border-radius:10px; width:90%; max-width:500px;">
    <h1>Inserir resposta da IA</h1>

    <label style="display:block; margin-top:10px;">Grupo:
      <select id="grupoInsercaoIA" onchange="atualizarSessoesIA()" style="width:100%; margin-top:5px; padding:6px; border-radius:6px; background:var(--color-background); color:var(--color-text); border:1px solid #ccc;"></select>
    </label>

    <label style="display:block; margin-top:10px;">Saudação:
      <select id="secaoInsercaoIA" onchange="atualizarPreviewCaixas()" style="width:100%; margin-top:5px; padding:6px; border-radius:6px; background:var(--color-background); color:var(--color-text); border:1px solid #ccc;"></select>
    </label>

    <fieldset style="border:none; margin-top:10px; margin-bottom:10px;">
      <label><input type="radio" name="modoInsercaoIA" value="nova" checked onchange="atualizarPreviewCaixas()"> Criar nova caixa</label><br/>
      <label><input type="radio" name="modoInsercaoIA" value="substituir" onchange="atualizarPreviewCaixas()"> Substituir caixa(s)</label>
    </fieldset>

    <div id="previewCaixasIA" style="">
      <h4>Caixas existentes:</h4>
      <div id="listaCaixasIA" style=""></div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
      <button onclick="fecharSeletorDeInsercaoIA()">Cancelar</button>
      <button onclick="inserirRespostaNaSaudacao()">Inserir</button>
    </div>
  </div>
</div>



</body>

<script>
function abrirSeletorDeInsercaoIA() {
  selectedSections.clear();
  currentTextId = null;
  render();

  document.getElementById("popupInsercaoIA").style.display = "flex";

  const grupoSelect = document.getElementById("grupoInsercaoIA");
  grupoSelect.innerHTML = "";

  Object.keys(groups).forEach(g => {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    grupoSelect.appendChild(opt);
  });

  atualizarSessoesIA();
}



function atualizarSessoesIA() {
  // 🧼 LIMPA a seleção de caixas de saudação
  currentTextId = null;
  document.querySelectorAll('.mensagem textarea').forEach(t => t.classList.remove('selecionado'));

  const grupo = document.getElementById("grupoInsercaoIA").value;
  const secaoSelect = document.getElementById("secaoInsercaoIA");
  secaoSelect.innerHTML = "";

  Object.keys(groups[grupo] || {}).forEach(secao => {
    const opt = document.createElement("option");
    opt.value = secao;
    opt.textContent = secao;
    secaoSelect.appendChild(opt);
  });

  atualizarPreviewCaixas();
}


function atualizarPreviewCaixas() {
  const modo = document.querySelector('input[name="modoInsercaoIA"]:checked').value;
  const grupo = document.getElementById("grupoInsercaoIA").value;
  const secao = document.getElementById("secaoInsercaoIA").value;
  const previewDiv = document.getElementById("previewCaixasIA");
  const textarea = previewDiv.querySelector("textarea");

  if (modo === "substituir" && groups[grupo] && groups[grupo][secao]) {
    const primeiraMensagem = groups[grupo][secao][0] || "(vazio)";
    textarea.value = primeiraMensagem;
    previewDiv.style.display = "block";
  } else {
    previewDiv.style.display = "none";
	// Força todos os checkboxes a iniciarem desmarcados
document.querySelectorAll('input[name="caixasSelecionadas"]').forEach(cb => cb.checked = false);

  }
}

function fecharSeletorDeInsercaoIA() {
  document.getElementById("popupInsercaoIA").style.display = "none";
}

function inserirRespostaNaSaudacao() {
  const resposta = document.getElementById("respostaIA").value.trim();
  if (!resposta) return showToast("Nenhuma resposta gerada.");
  const grupo = document.getElementById("grupoInsercaoIA").value;
  const secao = document.getElementById("secaoInsercaoIA").value;
  const modo = document.querySelector('input[name="modoInsercaoIA"]:checked').value;
  if (!groups[grupo] || !groups[grupo][secao]) {
    return showToast("Grupo ou saudação inválidos.");
  }
  if (modo === "nova") {
    groups[grupo][secao].push(resposta);
  } else {
    groups[grupo][secao][0] = resposta;
  }
  saveToLocalStorage();
  render();
  fecharSeletorDeInsercaoIA();
  showToast("Texto da IA inserido com sucesso!");
}
</script>
</html>

<script>
function showToast(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--color-primary);
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    z-index: 9999;
    font-family: 'Inter', sans-serif;
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2500);
}
</script>
<script>
function abrirSeletorDeInsercaoIA() {
  selectedSections.clear(); // limpa todas as caixas de saudação marcadas
  render(); // re-renderiza para atualizar visuais

  document.getElementById("popupInsercaoIA").style.display = "flex";

  currentTextId = null;
  document.querySelectorAll('.mensagem textarea').forEach(t => t.classList.remove('selecionado'));

  const grupoSelect = document.getElementById("grupoInsercaoIA");
  grupoSelect.innerHTML = "";

  Object.keys(groups).forEach(g => {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    grupoSelect.appendChild(opt);
  });

  atualizarSessoesIA();
}


function atualizarSessoesIA() {
  const grupo = document.getElementById("grupoInsercaoIA").value;
  const secaoSelect = document.getElementById("secaoInsercaoIA");
  secaoSelect.innerHTML = "";

  Object.keys(groups[grupo] || {}).forEach(secao => {
    const opt = document.createElement("option");
    opt.value = secao;
    opt.textContent = secao;
    secaoSelect.appendChild(opt);
  });

  atualizarPreviewCaixas();
}

function atualizarPreviewCaixas() {
  const modo = document.querySelector('input[name="modoInsercaoIA"]:checked').value;
  const grupo = document.getElementById("grupoInsercaoIA").value;
  const secao = document.getElementById("secaoInsercaoIA").value;
  const preview = document.getElementById("previewCaixasIA");
  const lista = document.getElementById("listaCaixasIA");

  lista.innerHTML = "";

  if (modo === "substituir" && groups[grupo] && groups[grupo][secao]) {
    preview.style.display = "block";
    const mensagens = groups[grupo][secao];
    mensagens.forEach((msg, i) => {
      const wrapper = document.createElement("label");
      wrapper.style.display = "";
      wrapper.style.alignItems = "center";
      wrapper.style.gap = "10px";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.name = "caixasSelecionadas";
      checkbox.value = i;

      const text = document.createElement("textarea");
      text.readOnly = true;
      text.value = msg;
      text.style = " resize:vertical; background:var(--color-background); color:var(--color-text); border:1px solid #ccc; border-radius:6px; padding:6px;";

      wrapper.appendChild(checkbox);
      wrapper.appendChild(text);
      lista.appendChild(wrapper);
    });
  } else {
    preview.style.display = "none";
  }
}

function fecharSeletorDeInsercaoIA() {
  document.getElementById("popupInsercaoIA").style.display = "none";
}

function inserirRespostaNaSaudacao() {
  const resposta = document.getElementById("respostaIA").value.trim();
  if (!resposta) return showToast("Nenhuma resposta gerada.");

  const grupo = document.getElementById("grupoInsercaoIA").value;
  const secao = document.getElementById("secaoInsercaoIA").value;
  const modo = document.querySelector('input[name="modoInsercaoIA"]:checked').value;

  if (!groups[grupo] || !groups[grupo][secao]) {
    return showToast("Grupo ou saudação inválidos.");
  }

  if (modo === "nova") {
    groups[grupo][secao].push(resposta);
  } else {
    const selecionadas = Array.from(document.querySelectorAll('input[name="caixasSelecionadas"]:checked')).map(cb => parseInt(cb.value));
    if (selecionadas.length === 0) return showToast("Selecione pelo menos uma caixa.");
    selecionadas.forEach(i => {
      groups[grupo][secao][i] = resposta;
    });
  }

  saveToLocalStorage();
  render();
  fecharSeletorDeInsercaoIA();
  showToast("Texto da IA inserido com sucesso!");
}
</script>
	
    <div id="automacao-conteudo">
      <p hidden>style="color: #ccc;">(Conteúdo completo da automação está embutido aqui. Veja a versão final no arquivo exportado.)</p>
    </div>
  </div>
  
    </div>

  <!-- Página Automação2 -->
  <div id="page-automacao2" class="pagina">
    <button class="voltar" onclick="navegarPara('page-menu')">← Voltar</button>
    <!-- Conteúdo da automação inserido abaixo -->
    <div id="automacao-conteudo">
      <p style="color: #ccc;">Aguardem as novidades que a DEV.associados pode oferecer para a sua empresa!.</p> 
    </div>
  </div>

  <script>
    function validarSerial() {
  const input = document.getElementById("serialInput").value.trim();
  const erro = document.getElementById("erroSerial");

  let serialDecoded;
  try {
    serialDecoded = JSON.parse(atob(input));
  } catch (e) {
    erro.style.display = "block";
    return;
  }

  if (!serialDecoded || !serialDecoded.criado || !serialDecoded.validadeDias) {
    erro.style.display = "block";
    return;
  }

  const criado = new Date(serialDecoded.criado);
  const expira = new Date(criado.getTime() + serialDecoded.validadeDias * 86400000);
  const agora = new Date();

  if (agora > expira) {
    erro.style.display = "block";
    return;
  }

  // Salvando informações
  localStorage.setItem("serialAutenticado", input);
  localStorage.setItem("validadeLicenca", expira.toISOString().split("T")[0]); // formato YYYY-MM-DD
  document.getElementById("page-auth").classList.remove("ativa");
  document.getElementById("page-menu").classList.add("ativa");
  erro.style.display = "none";
}


    function navegarPara(id) {
      document.querySelectorAll('.pagina').forEach(div => div.classList.remove('ativa'));
      document.getElementById(id).classList.add('ativa');
    }

    function logout() {
      document.getElementById("serialInput").value = "";
      document.querySelectorAll('.pagina').forEach(div => div.classList.remove('ativa'));
      document.getElementById("page-auth").classList.add("ativa");
    }
  </script>

		<!-- BOTÃO GLOBAL DE LICENÇA -->
		<div id="botaoLicenca" style="position: fixed; top: 10px; right: 20px; z-index: 9999; display: none;">
		  <button id="licencaBtn" onclick="abrirPopupLicenca()" style="padding: 12px 18px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;"></button>
		</div>

		<!-- POPUP DE RENOVAÇÃO -->
		<div id="popupLicenca" onclick="fecharPopupLicenca()" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 99999; align-items: center; justify-content: center;">
		  <div onclick="event.stopPropagation()" style="background: #222; color: white; border-radius: 12px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 0 12px #000;">
			<h2 style="margin-top: 0;">🔁 Renovar Licença</h2>

			<label for="mesesSelecionados">Meses de Assinatura:</label>
			<select id="mesesSelecionados" onchange="atualizarValor()" style="width: 100%; padding: 10px; margin: 10px 0; background: #333; color: white; border: none;">
			  <option value="1">1 mês</option>
			  <option value="2">2 meses</option>
			  <option value="3">3 meses</option>
			  <option value="4">4 meses</option>
			  <option value="5">5 meses</option>
			  <option value="6">6 meses</option>
			</select>

			<div id="valorLicenca" style="font-size: 18px; margin-bottom: 20px;">Valor total: R$ 35,00</div>

			<div>
			  <strong>Chave Pix:</strong><br>
			  <code style="color: #0f0;">60.788.906/0001-44</code>
			</div>

			<div style="margin-top: 20px; text-align: center;">
			  <button onclick="gerarQRCodePix()" style="background: #4caf50; color: white; border: none; padding: 10px 16px; border-radius: 8px; width: 100%; margin-bottom: 10px;">Gerar QR Code de Pagamento</button>
			</div>

			<div id="qrDinamico" style="text-align: center; margin: 20px 0;"></div>

			<button onclick="fecharPopupLicenca()" style="margin-top: 10px; background: #f57c00; color: white; border: none; padding: 10px 16px; border-radius: 8px; width: 100%;">Fechar</button>
		  </div>
		</div>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
		<script>
		const valorBase = 35;
		const descontosFibonacci = [0, 0, 3, 5, 8, 13, 21];

		function diasRestantesDoSerial() {
		  const dataStr = localStorage.getItem('validadeLicenca');
		  if (!dataStr) return null;
		  const dataFinal = new Date(dataStr + 'T23:59:59');
		  const agora = new Date();
		  const diff = dataFinal - agora;
		  return Math.floor(diff / (1000 * 60 * 60 * 24));
		}

		function atualizarBotaoLicenca() {
		  const btn = document.getElementById('licencaBtn');
		  const dias = diasRestantesDoSerial();

		  if (document.querySelector('.pagina.ativa')?.id === 'page-auth') {
			document.getElementById('botaoLicenca').style.display = 'none';
			return;
		  }

		  if (dias == null) {
			btn.innerText = 'Licença desconhecida';
			btn.style.background = 'gray';
			btn.style.color = 'white';
			document.getElementById('botaoLicenca').style.display = 'block';
			return;
		  }

		  let texto = '';
		  if (dias > 10) {
			btn.style.background = 'green';
			texto = 'Licença Ativa';
		  } else if (dias > 2) {
			btn.style.background = 'orange';
			texto = `Expira em ${dias} dias`;
		  } else if (dias >= 0) {
			btn.style.background = 'red';
			texto = 'Renove sua Licença';
		  } else {
			btn.style.background = 'red';
			texto = 'Licença expirada';
		  }

		  btn.style.color = (dias > 2) ? 'white' : 'black';
		  btn.innerText = texto;
		  document.getElementById('botaoLicenca').style.display = 'block';
		}

		function abrirPopupLicenca() {
		  document.getElementById('popupLicenca').style.display = 'flex';
		  atualizarValor();
		}

		function fecharPopupLicenca() {
		  document.getElementById('popupLicenca').style.display = 'none';
		}

		function atualizarValor() {
		  const meses = parseInt(document.getElementById('mesesSelecionados').value);
		  let valor = meses * valorBase;
		  if (meses <= 6) valor -= descontosFibonacci[meses];
		  document.getElementById('valorLicenca').innerText = `Valor total: R$ ${valor.toFixed(2).replace('.', ',')}`;
		}
// 🔧 Gera o CRC16 exigido pelo padrão EMV do Pix
function crc16(payload) {
  let polinomio = 0x1021;
  let resultado = 0xFFFF;
  for (let i = 0; i < payload.length; i++) {
    resultado ^= payload.charCodeAt(i) << 8;
    for (let j = 0; j < 8; j++) {
      if ((resultado <<= 1) & 0x10000) resultado ^= polinomio;
      resultado &= 0xFFFF;
    }
  }
  return resultado.toString(16).toUpperCase().padStart(4, '0');
}

function gerarQRCodePix() {
  const meses = parseInt(document.getElementById('mesesSelecionados').value);
  let valor = meses * valorBase;
  if (meses <= 6) valor -= descontosFibonacci[meses];

  const cnpj = '60788906000144';
  const nome = 'Lucas Oliveira Gomes'; // Máx 25 caracteres
  const cidade = 'LEM BA';
  const valorFormatado = valor.toFixed(2);

  // 🧾 Monta payload Pix EMV
  const payloadSemCRC = [
    '000201',
    '26360014BR.GOV.BCB.PIX',
    `01${cnpj.length.toString().padStart(2, '0')}${cnpj}`,
    '52040000',
    '5303986',
    `54${valorFormatado.length.toString().padStart(2, '0')}${valorFormatado}`,
    '5802BR',
    `59${nome.length.toString().padStart(2, '0')}${nome}`,
    `60${cidade.length.toString().padStart(2, '0')}${cidade}`,
    '62070503***',
    '6304'
  ].join('');

  const payloadFinal = payloadSemCRC + crc16(payloadSemCRC);

  const qrDinamico = document.getElementById('qrDinamico');
  qrDinamico.innerHTML = '';

  const qrPix = new QRious({
    element: document.createElement('canvas'),
    value: payloadFinal,
    size: 200
  });

  qrDinamico.appendChild(qrPix.element);

  const botaoWhatsapp = document.createElement('a');
  botaoWhatsapp.href = `https://wa.me/5577998199103?text=Olá, segue o comprovante do pagamento de R$ ${valorFormatado}.`;
  botaoWhatsapp.target = '_blank';
  botaoWhatsapp.innerText = 'Enviar comprovante via WhatsApp';
  botaoWhatsapp.style.display = 'block';
  botaoWhatsapp.style.marginTop = '10px';
  botaoWhatsapp.style.background = '#25d366';
  botaoWhatsapp.style.color = 'white';
  botaoWhatsapp.style.padding = '10px';
  botaoWhatsapp.style.borderRadius = '8px';
  qrDinamico.appendChild(botaoWhatsapp);

  const labelMini = document.createElement('div');
  labelMini.innerText = 'Ou escaneie aqui para enviar:';
  labelMini.style.marginTop = '10px';
  labelMini.style.fontSize = '14px';
  labelMini.style.color = '#ccc';
  qrDinamico.appendChild(labelMini);

  const qrWhats = new QRious({
    element: document.createElement('canvas'),
    value: botaoWhatsapp.href,
    size: 140
  });

  qrDinamico.appendChild(qrWhats.element);
}

		setInterval(atualizarBotaoLicenca, 3000);
		setInterval(() => {
		  const dias = diasRestantesDoSerial();
		  if (dias !== null && dias < 0) {
			alert("Sua licença expirou. Faça a renovação para continuar.");
			logout();
		  }
		}, 5000);
		</script>


</body>
</html>
